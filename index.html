<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cash receipt - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root { --theme-color: #2c3e50; --bg-color: #f3f4f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .controls { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; width: 100%; justify-content: center; padding-bottom: 5px; }
        button { padding: 8px 12px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-save { background-color: #198754; color: white; }
        .btn-history { background-color: #ffc107; color: #000; }
        .btn-export { background-color: #0d6efd; color: white; }
        .btn-clear { background-color: #dc3545; color: white; }
        .btn-add { background-color: var(--theme-color); color: white; width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; }
        .btn-csv { background-color: #157347; color: white; width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        
        .bill-paper { background: white; width: 100%; max-width: 400px; padding: 25px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; box-sizing: border-box; border-top: 6px solid var(--theme-color); }
        .editable-input { width: 100%; border: none; background: transparent; font-family: 'Sarabun', sans-serif; outline: none; }
        .header-section { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .shop-name { font-size: 1.4rem; font-weight: 700; color: var(--theme-color); }
        .shop-addr { font-size: 0.8rem; color: #444; min-height: 4.5em; line-height: 1.4; resize: none; width: 100%; }
        .input-row { display: flex; align-items: baseline; margin-bottom: 6px; font-size: 0.9rem; }
        .input-row label { color: var(--theme-color); font-weight: 600; min-width: 110px; font-size: 0.75rem; }
        .input-row input { flex: 1; border: none; border-bottom: 1px dotted #ccc; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background-color: #eee; border: 1px solid var(--theme-color); padding: 4px; font-size: 0.7rem; }
        td { border: 1px solid #ddd; padding: 6px 4px; }
        .summary-line { display: flex; justify-content: space-between; padding: 3px 10px; font-size: 0.85rem; align-items: center; }
        .total-line { display: flex; justify-content: space-between; padding: 8px 10px; background: var(--theme-color); color: white; font-weight: bold; border-radius: 4px; margin-top: 5px; font-size: 1.1rem; }
        .baht-text { font-size: 0.65rem; text-align: right; margin-top: 5px; color: #555; }
        .credit-text { text-align: center; font-size: 0.7rem; color: #aaa; margin-top: 30px; line-height: 1.6; }
        .calc-input { width: 40px; border: none; border-bottom: 1px solid #ccc; text-align: center; font-family: 'Sarabun'; font-weight: bold; color: var(--theme-color); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 380px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .daily-summary { background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; color: var(--theme-color); border-left: 5px solid var(--theme-color); }
        .history-card { background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85rem; }
        .btn-del { color: #dc3545; font-size: 0.75rem; cursor: pointer; float: right; border: 1px solid #dc3545; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="controls">
        <button class="btn-save" onclick="saveBill()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)</button>
        <button class="btn-history" onclick="openHistory()">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)</button>
        <button class="btn-export" onclick="exportImage()">üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image)</button>
        <button class="btn-clear" onclick="createNew()">üìÑ ‡πÉ‡∏´‡∏°‡πà (New)</button>
    </div>

    <div id="billEditor" class="bill-paper">
        <div class="header-section">
            <div style="width: 65%;">
                <input type="text" class="editable-input shop-name" id="shopName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô / Shop Name" onchange="saveShopInfo()">
                <textarea class="editable-input shop-addr" id="shopAddr" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ / Address & Tel" onchange="saveShopInfo()"></textarea>
            </div>
            <div style="text-align: right; font-size: 0.7rem; color: var(--theme-color);">
                <b>No.</b> <input type="text" id="billNo" style="width:65px; border:none; border-bottom:1px solid #000; text-align:center;" readonly><br>
                <b>Date:</b> <input type="date" id="billDate" style="border:none; font-family:'Sarabun'; width: 110px;">
            </div>
        </div>

        <div class="customer-info">
            <div class="input-row"><label>‡∏ô‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Name:</label><input type="text" id="custName" class="editable-input"></div>
            <div class="input-row"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / Address:</label><input type="text" id="custAddr" class="editable-input"></div>
        </div>

        <table>
            <thead><tr><th style="width:15%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô<br>Qty</th><th style="width:50%;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>Description</th><th style="width:15%;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞<br>Price</th><th style="width:20%;">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô<br>Amount</th></tr></thead>
            <tbody id="itemsBody"></tbody>
        </table>
        <button class="btn-add" onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Add Item)</button>

        <div style="margin-top: 15px;">
            <div class="summary-line"><span>‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô / Subtotal</span><span id="subTotal">0.00</span></div>
            <div class="summary-line"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î / Discount <input type="number" id="discountRate" class="calc-input" placeholder="0" onkeyup="calcTotal()"> %</span><span id="discountAmount">0.00</span></div>
            <div class="summary-line"><span>‡∏†‡∏≤‡∏©‡∏µ / VAT <input type="number" id="vatRate" class="calc-input" placeholder="0" onkeyup="calcTotal()"> %</span><span id="vatAmount">0.00</span></div>
            <div class="total-line"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ / Total</span><span id="grandTotal">0.00</span></div>
            <div class="baht-text" id="bahtText">( ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô / Zero Baht Only )</div>
        </div>

        <textarea id="paymentInfo" style="width:100%; margin-top:10px; font-size:0.7rem; height:45px; border:1px dashed #ccc; border-radius:4px;" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô..." onchange="saveShopInfo()"></textarea>

        <div class="credit-text">
            <strong>Cash receipt App | Version 1.2.3</strong><br>
            ¬© 2026 All Rights Reserved | Developed by Gemini & Ton7788<br>
            Contact: +66 88 897 7466
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (History)</h3>
            <button class="btn-csv" onclick="exportToCSV()">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel (CSV)</button>
            <div id="historyList"></div>
            <button onclick="document.getElementById('historyModal').style.display='none'" style="width:100%; margin-top:15px; padding:10px;">‡∏õ‡∏¥‡∏î (Close)</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY_HISTORY = 'cash_receipt_history';
        const STORAGE_KEY_CONFIG = 'cash_receipt_config';

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('billDate').valueAsDate = new Date();
            loadShopInfo(); generateBillNo(); addRow();
            if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
        });

        function addRow(data = {}) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="number" class="qty editable-input" style="text-align:center" onkeyup="calcTotal()"></td><td><input type="text" class="desc editable-input"></td><td><input type="number" class="price editable-input" style="text-align:right" onkeyup="calcTotal()"></td><td style="text-align:right" class="row-total"></td>`;
            document.getElementById('itemsBody').appendChild(tr);
        }

        function calcTotal() {
            let subtotal = 0;
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                const q = parseFloat(row.querySelector('.qty').value) || 0;
                const p = parseFloat(row.querySelector('.price').value) || 0;
                const sum = q * p;
                row.querySelector('.row-total').innerText = sum > 0 ? sum.toFixed(2) : '';
                subtotal += sum;
            });
            const dAmount = subtotal * ((parseFloat(document.getElementById('discountRate').value) || 0) / 100);
            const vAmount = (subtotal - dAmount) * ((parseFloat(document.getElementById('vatRate').value) || 0) / 100);
            const grand = subtotal - dAmount + vAmount;
            document.getElementById('subTotal').innerText = subtotal.toFixed(2);
            document.getElementById('discountAmount').innerText = dAmount.toFixed(2);
            document.getElementById('vatAmount').innerText = vAmount.toFixed(2);
            document.getElementById('grandTotal').innerText = grand.toFixed(2);
            document.getElementById('bahtText').innerText = `( ${ThaiBaht(grand)} / ${grand.toFixed(2)} Baht Only )`;
            return grand;
        }

        function saveBill() {
            const total = calcTotal();
            const billData = { id: Date.now(), billNo: document.getElementById('billNo').value, date: document.getElementById('billDate').value, cust: document.getElementById('custName').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', total: total };
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            history.unshift(billData);
            localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); generateBillNo();
        }

        function openHistory() {
            const list = document.getElementById('historyList');
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            if (!history.length) { list.innerHTML = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'; } else {
                let html = '';
                const groups = history.reduce((acc, b) => { acc[b.date] = (acc[b.date] || 0) + b.total; return acc; }, {});
                Object.keys(groups).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
                    html += `<div class="daily-summary">üìÖ ${date} | ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${groups[date].toLocaleString()} ‡∏ö.</div>`;
                    history.filter(b => b.date === date).forEach(b => {
                        html += `<div class="history-card"><span class="btn-del" onclick="deleteBill(${b.id})">‡∏•‡∏ö</span><b>${b.billNo}</b> | ${b.cust}<br>‡∏¢‡∏≠‡∏î: ${b.total.toLocaleString()} ‡∏ö.</div>`;
                    });
                });
                list.innerHTML = html;
            }
            document.getElementById('historyModal').style.display = 'block';
        }

        function deleteBill(id) { if (confirm('‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÉ‡∏ö‡∏ô‡∏µ‡πâ?')) { let h = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)).filter(b => b.id !== id); localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(h)); openHistory(); } }

        function exportToCSV() {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            if (!history.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            let csv = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•,‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤,‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°\n";
            history.forEach(b => csv += `${b.date},${b.billNo},${b.cust},${b.total}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Sales_Report_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function generateBillNo() { document.getElementById('billNo').value = `RE-${Math.floor(Math.random()*9000)+1000}`; }
        function saveShopInfo() { localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify({ name: document.getElementById('shopName').value, addr: document.getElementById('shopAddr').value, pay: document.getElementById('paymentInfo').value })); }
        function loadShopInfo() { const c = JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG)); if(c){ document.getElementById('shopName').value=c.name; document.getElementById('shopAddr').value=c.addr; document.getElementById('paymentInfo').value=c.pay; } }
        function exportImage() { html2canvas(document.getElementById('billEditor'), { scale: 2 }).then(canvas => { const link = document.createElement('a'); link.download = `Bill.png`; link.href = canvas.toDataURL(); link.click(); }); }
        function createNew() { if(confirm('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà?')) location.reload(); }
        function ThaiBaht(n) { return n > 0 ? "‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô" : "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô"; } // Simplified for length, keep your full version
    </script>
</body>
</html>