<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cash receipt - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root { --theme-color: #2c3e50; --bg-color: #f3f4f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .controls { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; width: 100%; justify-content: center; padding-bottom: 5px; }
        button { padding: 10px 15px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: 'Sarabun'; }
        .btn-save { background-color: #198754; color: white; }
        .btn-history { background-color: #ffc107; color: #000; }
        .btn-export { background-color: #0d6efd; color: white; }
        .btn-clear { background-color: #dc3545; color: white; }
        .btn-add { background-color: var(--theme-color); color: white; width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; }
        .btn-csv { background-color: #157347; color: white; width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; }

        .bill-paper { background: white; width: 100%; max-width: 450px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; box-sizing: border-box; border-top: 8px solid var(--theme-color); line-height: 1.4; }
        .editable-input { width: 100%; border: none; background: transparent; font-family: 'Sarabun', sans-serif; outline: none; padding: 2px 0; }
        
        .header-section { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .shop-info { width: 65%; }
        .shop-name { font-size: 1.4rem; font-weight: 700; color: var(--theme-color); margin-bottom: 5px; }
        .shop-addr { font-size: 0.85rem; color: #333; min-height: 4em; resize: none; width: 100%; display: block; overflow: hidden; white-space: pre-wrap; }
        
        .bill-meta { width: 32%; display: flex; flex-direction: column; gap: 5px; text-align: right; }
        .meta-row { display: flex; align-items: center; justify-content: flex-end; font-size: 0.75rem; }
        .meta-label { font-weight: 700; color: var(--theme-color); margin-right: 5px; white-space: nowrap; }
        .meta-value { width: 85px; border-bottom: 1px solid #ccc; text-align: center; padding: 1px; font-weight: bold; min-height: 1.1em; font-size: 0.75rem; }

        .customer-section { margin-bottom: 15px; }
        .input-row { display: flex; align-items: baseline; margin-bottom: 8px; font-size: 0.9rem; }
        .input-row label { color: var(--theme-color); font-weight: 700; min-width: 110px; font-size: 0.8rem; }
        .input-row input { flex: 1; border-bottom: 1px dotted #bbb; font-size: 0.95rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th { background-color: #f8f9fa; border: 1px solid var(--theme-color); padding: 8px 4px; font-size: 0.75rem; color: var(--theme-color); }
        td { border: 1px solid #ddd; padding: 8px 4px; word-wrap: break-word; vertical-align: top; }
        .col-qty { width: 15%; text-align: center; }
        .col-desc { width: 50%; }
        .col-price { width: 15%; text-align: right; }
        .col-amt { width: 20%; text-align: right; font-weight: bold; }

        .summary-area { margin-top: 20px; border-top: 2px solid #eee; padding-top: 10px; }
        .summary-line { display: flex; justify-content: space-between; padding: 4px 5px; font-size: 0.9rem; align-items: center; }
        .summary-label-box { display: flex; align-items: center; gap: 5px; flex-grow: 1; }
        .summary-value { min-width: 100px; text-align: right; font-weight: 600; }

        .total-line { display: flex; justify-content: space-between; padding: 10px; background: var(--theme-color); color: white; font-weight: bold; border-radius: 4px; margin-top: 10px; font-size: 1.2rem; }
        .baht-text { font-size: 0.8rem; text-align: right; margin-top: 5px; color: #333; font-weight: bold; }
        
        .payment-box { width: 100%; margin-top: 15px; font-size: 0.8rem; height: 50px; border: 1px dashed #bbb; border-radius: 4px; padding: 5px; box-sizing: border-box; background: #fffaf0; }
        .collector-row { margin-top: 20px; text-align: center; font-size: 0.9rem; color: var(--theme-color); }
        .collector-input { border: none; border-bottom: 1px dotted #000; width: 180px; text-align: center; font-family: 'Sarabun'; outline: none; font-weight: 500; }
        .credit-text { text-align: center; font-size: 0.7rem; color: #999; margin-top: 40px; line-height: 1.6; border-top: 1px solid #eee; padding-top: 10px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        .daily-summary { background: #e9ecef; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; border-left: 6px solid var(--theme-color); font-size: 0.9rem; }
        .history-card { background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 10px; margin-bottom: 10px; font-size: 0.85rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        #export-clone-container { position: absolute; left: -9999px; top: 0; }
        .calc-input { width: 45px; border: none; border-bottom: 1px solid #ccc; text-align: center; font-family: 'Sarabun'; font-weight: bold; color: var(--theme-color); }
    </style>
</head>
<body>

    <div class="controls">
        <button class="btn-save" onclick="saveBill()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)</button>
        <button class="btn-history" onclick="openHistory()">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)</button>
        <button class="btn-export" onclick="exportImage()">üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image)</button>
        <button class="btn-clear" onclick="createNew()">üìÑ ‡πÉ‡∏´‡∏°‡πà (New)</button>
    </div>

    <div id="billEditor" class="bill-paper">
        <div class="header-section">
            <div class="shop-info">
                <input type="text" class="editable-input shop-name" id="shopName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô / Shop Name" onchange="saveShopInfo()">
                <textarea class="editable-input shop-addr" id="shopAddr" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ / Address & Tel" onchange="saveShopInfo()"></textarea>
            </div>
            <div class="bill-meta">
                <div class="meta-row">
                    <span class="meta-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / No.</span>
                    <div class="meta-value" id="billNoDisplay"></div>
                    <input type="hidden" id="billNo">
                </div>
                <div class="meta-row">
                    <span class="meta-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date:</span>
                    <input type="date" class="editable-input meta-value" id="billDate">
                </div>
            </div>
        </div>

        <div class="customer-section">
            <div class="input-row"><label>‡∏ô‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Name:</label><input type="text" id="custName" class="editable-input"></div>
            <div class="input-row"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / Address:</label><input type="text" id="custAddr" class="editable-input"></div>
        </div>

        <table>
            <thead><tr><th class="col-qty">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô<br>Qty</th><th class="col-desc">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>Description</th><th class="col-price">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞<br>Price</th><th class="col-amt">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô<br>Amount</th></tr></thead>
            <tbody id="itemsBody"></tbody>
        </table>
        <button class="btn-add" onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Add Item)</button>

        <div class="summary-area">
            <div class="summary-line"><span class="summary-label-box">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô / Subtotal</span><span class="summary-value" id="subTotal">0.00</span></div>
            <div class="summary-line" id="discountLine">
                <div class="summary-label-box">
                    <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î / Discount</span>
                    <input type="number" id="discountRate" class="calc-input" placeholder="" onkeyup="calcTotal()">
                    <span>%</span>
                </div>
                <span class="summary-value" id="discountAmount">0.00</span>
            </div>
            <div class="summary-line" id="vatLine">
                <div class="summary-label-box">
                    <span>‡∏†‡∏≤‡∏©‡∏µ / VAT</span>
                    <input type="number" id="vatRate" class="calc-input" placeholder="" onkeyup="calcTotal()">
                    <span>%</span>
                </div>
                <span class="summary-value" id="vatAmount">0.00</span>
            </div>
            <div class="total-line"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ / Total</span><span id="grandTotal">0.00</span></div>
            <div class="baht-text" id="bahtText">( ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô )</div>
        </div>

        <textarea id="paymentInfo" class="payment-box" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô..." onchange="saveShopInfo()"></textarea>

        <div class="collector-row">
            <input type="text" id="collectorName" class="collector-input" placeholder="( ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô )" onchange="saveShopInfo()"><br>
            <span style="font-size:0.75rem;">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / Collector</span>
        </div>

        <div class="credit-text">
            <strong>Cash receipt App | Version 1.3.6</strong><br>
            ¬© 2026 All Rights Reserved | Developed by Gemini & Ton7788<br>
            Contact: +66 88 897 7466
        </div>
    </div>

    <div id="export-clone-container"></div>
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--theme-color); border-bottom:2px solid #eee; padding-bottom:10px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (History)</h3>
            <button class="btn-csv" onclick="exportToCSV()">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (CSV)</button>
            <div id="historyList"></div>
            <button onclick="document.getElementById('historyModal').style.display='none'" style="width:100%; margin-top:20px; background:#6c757d; color:white; border-radius:10px; padding:12px;">‡∏õ‡∏¥‡∏î (Close)</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY_HISTORY = 'cash_receipt_history_v2';
        const STORAGE_KEY_CONFIG = 'cash_receipt_config';
        let currentBillId = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('billDate').valueAsDate = new Date();
            loadShopInfo(); generateBillNo(); addRow();
            if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
        });

        function addRow(data = {}) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="col-qty"><input type="number" class="qty editable-input" style="text-align:center" value="${data.qty || ''}" onkeyup="calcTotal()"></td>
                <td class="col-desc"><input type="text" class="desc editable-input" value="${data.desc || ''}"></td>
                <td class="col-price"><input type="number" class="price editable-input" style="text-align:right" value="${data.price || ''}" onkeyup="calcTotal()"></td>
                <td class="col-amt row-total">${data.total || ''}</td>
            `;
            document.getElementById('itemsBody').appendChild(tr);
        }

        function calcTotal() {
            let subtotal = 0;
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                const q = parseFloat(row.querySelector('.qty').value) || 0;
                const p = parseFloat(row.querySelector('.price').value) || 0;
                const sum = q * p;
                row.querySelector('.row-total').innerText = sum > 0 ? sum.toFixed(2) : '';
                subtotal += sum;
            });
            const dRate = parseFloat(document.getElementById('discountRate').value) || 0;
            const dAmount = subtotal * (dRate / 100);
            const vRate = parseFloat(document.getElementById('vatRate').value) || 0;
            const vAmount = (subtotal - dAmount) * (vRate / 100);
            const grand = subtotal - dAmount + vAmount;

            document.getElementById('subTotal').innerText = subtotal.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('discountAmount').innerText = dAmount.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('vatAmount').innerText = vAmount.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('grandTotal').innerText = grand.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('bahtText').innerText = `( ${ThaiBaht(grand)} )`;
            return grand;
        }

        function generateBillNo() {
            if (currentBillId) return;
            const h = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            const now = new Date();
            const prefix = `${(now.getFullYear()+543).toString().slice(-2)}${String(now.getMonth()+1).padStart(2,'0')}`;
            const monthBills = h.filter(b => b.billNo.startsWith(prefix));
            let nextSeq = 1;
            if (monthBills.length > 0) {
                const sorted = monthBills.sort((a,b) => b.billNo.localeCompare(a.billNo));
                nextSeq = parseInt(sorted[0].billNo.split('-')[1]) + 1;
            }
            const res = `${prefix}-${String(nextSeq).padStart(3, '0')}`;
            document.getElementById('billNo').value = res;
            document.getElementById('billNoDisplay').innerText = res;
        }

        function saveBill() {
            const total = calcTotal();
            const items = [];
            document.querySelectorAll('#itemsBody tr').forEach(r => {
                const qty = r.querySelector('.qty').value;
                const desc = r.querySelector('.desc').value;
                const price = r.querySelector('.price').value;
                if(qty || desc) items.push({ qty, desc, price, total: r.querySelector('.row-total').innerText });
            });
            const billData = { 
                id: currentBillId || Date.now(), billNo: document.getElementById('billNo').value, date: document.getElementById('billDate').value, custName: document.getElementById('custName').value, custAddr: document.getElementById('custAddr').value, items: items, discountRate: document.getElementById('discountRate').value, vatRate: document.getElementById('vatRate').value, total: total 
            };
            let h = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            if (currentBillId) { h = h.map(b => b.id === currentBillId ? billData : b); } 
            else { h.unshift(billData); }
            localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(h));
            currentBillId = billData.id; alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }

        function exportImage() {
            const source = document.getElementById('billEditor');
            const container = document.getElementById('export-clone-container');
            container.innerHTML = '';
            const clone = source.cloneNode(true);
            
            ['discountLine', 'vatLine'].forEach(id => {
                const line = clone.querySelector(`#${id}`);
                if(line) {
                    const input = line.querySelector('input');
                    const rateVal = input.value || '';
                    const amount = line.querySelector('span[id$="Amount"]').innerText;
                    const label = line.querySelector('.summary-label-box span').innerText;
                    line.innerHTML = `<span class="summary-label-box">${label} ${rateVal ? rateVal + '%' : ''}</span><span class="summary-value">${amount}</span>`;
                }
            });

            clone.querySelectorAll('input, textarea').forEach(input => {
                if(input.type === 'hidden' || input.id === 'billNo') { input.remove(); return; }
                const span = document.createElement('span');
                const val = input.value || '';
                span.style.fontFamily = "'Sarabun', sans-serif";
                span.style.fontSize = getComputedStyle(input).fontSize;
                span.style.fontWeight = getComputedStyle(input).fontWeight;
                span.style.display = 'inline-block';
                span.style.width = '100%';
                span.style.whiteSpace = 'pre-wrap';
                span.style.textAlign = getComputedStyle(input).textAlign;
                
                span.innerText = (input.type === 'date' && val) ? new Date(val).toLocaleDateString('th-TH') : val;
                input.parentNode.replaceChild(span, input);
            });

            clone.querySelectorAll('button').forEach(b => b.remove());
            container.appendChild(clone);

            setTimeout(() => {
                html2canvas(clone, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Bill-${document.getElementById('billNoDisplay').innerText}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    container.innerHTML = ''; 
                });
            }, 100);
        }

        function saveShopInfo() {
            localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify({
                name: document.getElementById('shopName').value,
                addr: document.getElementById('shopAddr').value,
                pay: document.getElementById('paymentInfo').value,
                collector: document.getElementById('collectorName').value
            }));
        }

        function loadShopInfo() {
            const c = JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG));
            if(c){
                document.getElementById('shopName').value = c.name || '';
                document.getElementById('shopAddr').value = c.addr || '';
                document.getElementById('paymentInfo').value = c.pay || '';
                document.getElementById('collectorName').value = c.collector || '';
            }
        }

        function openHistory() {
            const list = document.getElementById('historyList');
            const h = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            list.innerHTML = h.length ? '' : '<p style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
            const groups = h.reduce((acc, b) => { acc[b.date] = (acc[b.date] || 0) + b.total; return acc; }, {});
            Object.keys(groups).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
                list.innerHTML += `<div class="daily-summary">üìÖ ${date} | ‡∏£‡∏ß‡∏°: ${groups[date].toLocaleString()} ‡∏ö.</div>`;
                h.filter(b => b.date === date).forEach(b => {
                    list.innerHTML += `<div class="history-card"><span style="color:red; cursor:pointer; float:right; margin-left:15px;" onclick="deleteBill(${b.id})">‡∏•‡∏ö</span><span style="color:#0d6efd; cursor:pointer; float:right; font-weight:bold;" onclick='loadBill(${b.id})'>‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</span><b>${b.billNo}</b> | ${b.custName || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}<br>‡∏¢‡∏≠‡∏î: ${b.total.toLocaleString()} ‡∏ö.</div>`;
                });
            });
            document.getElementById('historyModal').style.display = 'block';
        }

        function loadBill(id) {
            const h = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            const b = h.find(i => i.id === id);
            if (!b) return;
            currentBillId = b.id;
            document.getElementById('billNo').value = b.billNo;
            document.getElementById('billNoDisplay').innerText = b.billNo;
            document.getElementById('billDate').value = b.date;
            document.getElementById('custName').value = b.custName || '';
            document.getElementById('custAddr').value = b.custAddr || '';
            document.getElementById('discountRate').value = b.discountRate || '';
            document.getElementById('vatRate').value = b.vatRate || '';
            document.getElementById('itemsBody').innerHTML = '';
            b.items.forEach(item => addRow(item));
            calcTotal(); document.getElementById('historyModal').style.display = 'none';
        }

        function deleteBill(id) { if (confirm('‡∏•‡∏ö?')) { let h = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)).filter(b => b.id !== id); localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(h)); openHistory(); } }
        function createNew() { if(confirm('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà?')) { currentBillId = null; document.getElementById('custName').value=''; document.getElementById('custAddr').value=''; document.getElementById('discountRate').value=''; document.getElementById('vatRate').value=''; document.getElementById('itemsBody').innerHTML=''; addRow(); generateBillNo(); calcTotal(); } }
        
        function ThaiBaht(n) {
            if (!n || n == 0) return "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô";
            const numbers = ["‡∏®‡∏π‡∏ô‡∏¢‡πå", "‡∏´‡∏ô‡∏∂‡πà‡∏á", "‡∏™‡∏≠‡∏á", "‡∏™‡∏≤‡∏°", "‡∏™‡∏µ‡πà", "‡∏´‡πâ‡∏≤", "‡∏´‡∏Å", "‡πÄ‡∏à‡πá‡∏î", "‡πÅ‡∏õ‡∏î", "‡πÄ‡∏Å‡πâ‡∏≤"];
            const units = ["", "‡∏™‡∏¥‡∏ö", "‡∏£‡πâ‡∏≠‡∏¢", "‡∏û‡∏±‡∏ô", "‡∏´‡∏°‡∏∑‡πà‡∏ô", "‡πÅ‡∏™‡∏ô", "‡∏•‡πâ‡∏≤‡∏ô"];

            function convert(numberStr) {
                let res = "";
                for (let i = 0; i < numberStr.length; i++) {
                    let num = parseInt(numberStr.charAt(i)), unitIndex = numberStr.length - i - 1;
                    if (num === 0) continue;
                    if (unitIndex === 1 && num === 2) res += "‡∏¢‡∏µ‡πà";
                    else if (unitIndex === 1 && num === 1) res += "";
                    else if (unitIndex === 0 && num === 1 && numberStr.length > 1) res += "‡πÄ‡∏≠‡πá‡∏î";
                    else res += numbers[num];
                    res += units[unitIndex];
                }
                return res;
            }

            let s = n.toFixed(2).split('.');
            let bahtText = convert(s[0]);
            let satangText = convert(s[1]);

            let result = (bahtText || "‡∏®‡∏π‡∏ô‡∏¢‡πå") + "‡∏ö‡∏≤‡∏ó";
            if (parseInt(s[1]) === 0) {
                result += "‡∏ñ‡πâ‡∏ß‡∏ô";
            } else {
                result += satangText + "‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå";
            }
            return result;
        }

        function exportToCSV() {
            const h = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            if (!h.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            let csv = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•,‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢,‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î(%),‡∏†‡∏≤‡∏©‡∏µ(%),‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥\n";
            h.forEach(b => b.items.forEach(item => {
                csv += `${b.date},${b.billNo},${(b.custName||'').replace(/,/g,' ')},${(item.desc||'').replace(/,/g,' ')},${item.qty},${item.price},${item.total},${b.discountRate}%,${b.vatRate}%,${b.total}\n`;
            }));
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Report_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>